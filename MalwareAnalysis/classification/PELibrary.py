import pefile
import peutils

import string
import datetime
import hashlib
import uuid

from math import log

class peData:
 	"""Analyze a PE file"""
 	def __init__(self, filename, sign):
 		self.filename=filename
 		self.file = pefile.PE(filename)
 		self.signatures = peutils.SignatureDatabase(sign)

 	def getOEP(self):
 		return self.file.OPTIONAL_HEADER.AddressOfEntryPoint

 	def getSections(self):
 		dictSections={}
 		for section in self.file.sections:
 			key=section.Name
 			dictSections[key.decode('ascii')]=section.VirtualAddress
 		return dictSections

 	def getImports(self):
 		if hasattr(self.file, 'DIRECTORY_ENTRY_IMPORT'):
 			listImports={}
 			for entry in self.file.DIRECTORY_ENTRY_IMPORT:
 				e=entry.dll
 				for i in entry.imports:
 					listImports[e.decode('ascii')]=(i.name).decode('ascii')
 			return listImports
 		else:
 			return None

 	def getExports(self):
 		listExports=[]
 		if hasattr(self.file, 'DIRECTORY_ENTRY_EXPORT'):
 			for e in self.file.DIRECTORY_ENTRY_EXPORT.symbols:
 				linecacheistExports+=(e.name).decode('ascii')
 			return listExports
 		else:
 			return None

 	def isPacked(self):
 		try:
 			m=self.signatures.match(self.file, ep_only=True)[0]
 		except:
 			m=None
 		return m

 	def getStrings(self):
 		strings=list()
 		f=open(self.filename,errors="ignore")
 		s=""
 		for c in f.read():
 			if c in string.printable:
 				s+=c
 				continue
 			if len(s)>=4:
 				strings.append(s)
 			s=""
 		if len(s)>=4:
 			strings.append(s)
 		f.close()

 		return strings

 	def getDate(self):
 		timestamp=self.file.FILE_HEADER.TimeDateStamp
 		return datetime.datetime.fromtimestamp(timestamp)

 	def extractFromFile(self, filename):
 		f=open(filename,'rb')
 		arrayByte={}
 		byte=f.read(1)
 		while (byte):
 			if byte not in arrayByte:
 				arrayByte[byte]=0
 			arrayByte[byte]+=1
 			byte=f.read(1)
 		f.close()
 		return arrayByte

 	def getEntropy(self):
 		d=self.extractFromFile(self.filename)
 		ent=0.0
 		tot=sum(d.values())
 		for v in d.values():
 			p=float(v)/tot
 			ent-=(p*log(p)/log(2))
 		return ent

def getMD5(filename):
 	return hashlib.md5(open(filename, 'rb').read()).hexdigest()

def getSHA256(filename):
 	return hashlib.sha256(open(filename, 'rb').read()).hexdigest()

def main():
	file="/home/harrapx/Documents/MalwareLabs/BinaryCollection/Chapter_1L/Lab01-02.exe"
	Packedfile="/home/harrapx/Documents/MalwareLabs/BinaryCollection/Chapter_11L/Lab11-03.exe"
	pe=peData(file, '/home/harrapx/Desktop/digitalforensic/MalwareAnalysis/MalwareAnalysis/userdb.txt')
	print(pe.getOEP())

if __name__ == '__main__':
	main()